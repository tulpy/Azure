# Azure Diagnostics extension and data cleanup

If you need to remove the [Azure Diagnostics extension](https://docs.microsoft.com/en-us/azure/azure-monitor/platform/diagnostics-extension-overview) at scale from your Azure virtual machine estate and finally clean the data that it generated, at least the largest one that lives in Azure Storage Tables, then you have here a complete procedure and scripts that will help you successfully achieve your goals.

The procedure is divided into three steps:

1. Assess which Azure Storage accounts are being used as a sink for the Diagnostics extension - carefully keep the generated CSV, because we will need this list for the last step.
2. Uninstall at scale the Diagnostics extension from your virtual machines.
3. Remove at scale the Azure Storage tables that were generated by the Diagnostics extension - we will use here the list extracted in the first step.

## Requirements

* [Az PowerShell modules](https://docs.microsoft.com/en-us/powershell/azure/install-Az-ps)
* [Az.ResourceGraph module](https://docs.microsoft.com/en-us/azure/governance/resource-graph/first-query-powershell#add-the-resource-graph-module)
* The user executing the scripts should have the Contributor role in the Azure subscriptions. If virtual machines have resource locks, then the user must have the Owner role.

## Step 1 - Extract the list of Storage Accounts containing Azure Diagnostics data

In a PowerShell prompt, run the [Export-VmDiagnosticsStorageAccounts.ps1](Export-VmDiagnosticsStorageAccounts.ps1) script:

`.\Export-VmDiagnosticsStorageAccounts.ps1 [-Cloud <AzureCloud | AzureChinaCloud | AzureGermanCloud | AzureUSGovernment>]`

This will generate a CSV file containing a list of all the Storage Accounts that are being used by the Azure Diagnostics extensions. Save this file, as we will need it for the last step.

## Step 2 - Uninstall at scale the Diagnostics extension from virtual machines

In the same PowerShell prompt, run the [Uninstall-VmDiagnosticsExtensionAtScale.ps1](Uninstall-VmDiagnosticsExtensionAtScale.ps1) script. The script is prepared to deal with the following scenarios:

* Deallocated virtual machines - it will start them, remove the extension, and shut them down again (only VMs with the extension will be started).
* Virtual machines that have a resource lock - it will remove the lock, remove the extension, and re-add the exact same lock - this requires you to have the Owner role for those virtual machines.
* Target a specific resource group or subscription.
* Make a dry run of the process with the `Simulate` switch.

Here is the full script syntax:

`.\Uninstall-VmDiagnosticsExtensionAtScale.ps1 [-Cloud <AzureCloud | AzureChinaCloud | AzureGermanCloud | AzureUSGovernment>] [-TargetSubscriptionId <subscription Id>] [-TargetResourceGroup <resource group name>] [-RemoveLocks] [-StartVMs] [-Simulate]`

With some examples

`.\Uninstall-VmDiagnosticsExtensionAtScale.ps1 -RemoveLocks -StartVMs -Simulate` - this will simulate an execution, starting deallocated VMs and removing resource locks before uninstalling the extension (of course, VMs won't be started nor locks removed)

`.\Uninstall-VmDiagnosticsExtensionAtScale.ps1 -TargetSubscriptionId aaaaaaaa-bbbb-cccc-dddd-eeeeeeeeeeee -StartVMs` - this will uninstall the extension only for the `aaaaaaaa-bbbb-cccc-dddd-eeeeeeeeeeee` subscription, starting deallocated VMs if needed.

The script will on-the-fly get the list of VMs to uninstall the extension from and will complete quickly, as the uninstallation is run asynchronously. At the end, you will get a CSV file containing the results of each uninstallation try, e.g., whether the VM was running or not, it had resource locks, or the extension was uninstalled. You must give at least 30 minutes for the process to finish. After this period, you can run the following query in Resource Graph Explorer, to check how successful the process was:

```powershell
resources 
| where type =~ 'microsoft.compute/virtualmachines/extensions' and tostring(properties.type) in ('LinuxDiagnostic', 'IaaSDiagnostics')
| project id, name
| extend vmId = substring(id, 0, indexof(id, '/extensions/'))
| join kind=inner (
    resources 
    | where type =~ 'microsoft.compute/virtualmachines'
    | project vmId = id, vmName = name, resourceGroup, subscriptionId, powerState = tostring(properties.extended.instanceView.powerState.code)
) on vmId
| project-away vmId, vmId1
| order by id asc
```

If, for some reason, there is some extension that does not remove successfully, refer to the [troubleshooting documentation](https://docs.microsoft.com/en-us/azure/azure-monitor/platform/diagnostics-extension-troubleshooting). Nevertheless, you can proceed with no fear to the final step - removing Azure Storage Tables. Those zombie Diagnostics extensions will recreate and continue writing into the Storage tables, but at least you'll have reduced your problem to a fraction of the dimension it had before. After fixing the extension issues, you can repeat steps 2 and 3.

## Step 3 - Remove the Azure Storage Tables used by the Diagnostics extension

In this final step, you'll use the CSV generated in step 1 and order the removal of all the Azure Storage Tables that are fed by the Diagnostics extension. The [Remove-VmDiagnosticsTables.ps1](Remove-VmDiagnosticsTables.ps1) script is very simple to use. If needed, you can target a specific subscription instead of the whole tenant.

`.\Remove-VmDiagnosticsTables.ps1 -StorageAccountsCsvPath <path to the storage account list CSV generated in step 1> [-Cloud <AzureCloud | AzureChinaCloud | AzureGermanCloud | AzureUSGovernment>] [-TargetSubscriptionId <subscription Id>]`

The script removes only the Storage Tables used by the Azure Diagnostics extension, leaving untouched all the remaining data that exist in the Storage Account, such as blobs or other tables used by other applications.

In the next day, you'll likely notice a drop in your Azure Storage Table costs. Happy cleanup!